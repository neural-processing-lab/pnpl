
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Speech Detection (LibriBrain) &#8212; PNPL</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=859acbfe" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'LibriBrain_Competition_Speech_Detection';</script>
    <link rel="icon" href="_static/pnpl-logo.png"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Phoneme Classification (LibriBrain)" href="LibriBrain_Competition_Phoneme_Classification.html" />
    <link rel="prev" title="LibriBrain" href="libribrain.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/pnpl-wordmark.png" class="logo__image only-light" alt="PNPL - Home"/>
    <script>document.write(`<img src="_static/pnpl-wordmark.png" class="logo__image only-dark" alt="PNPL - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Get Started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="install.html">Install</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="datasets.html">Public Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="libribrain.html">LibriBrain</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Speech Detection (LibriBrain)</a></li>
<li class="toctree-l1"><a class="reference internal" href="LibriBrain_Competition_Phoneme_Classification.html">Phoneme Classification (LibriBrain)</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="api/index.html">API Reference</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="api/generated/pnpl.datasets.libribrain2025.speech_dataset.LibriBrainSpeech.html">pnpl.datasets.libribrain2025.speech_dataset.LibriBrainSpeech</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/generated/pnpl.datasets.libribrain2025.phoneme_dataset.LibriBrainPhoneme.html">pnpl.datasets.libribrain2025.phoneme_dataset.LibriBrainPhoneme</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/generated/pnpl.datasets.grouped_dataset.GroupedDataset.html">pnpl.datasets.grouped_dataset.GroupedDataset</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/generated/pnpl.datasets.hdf5.dataset.HDF5Dataset.html">pnpl.datasets.hdf5.dataset.HDF5Dataset</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/generated/pnpl.datasets.libribrain2025.constants.html">pnpl.datasets.libribrain2025.constants</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/generated/pnpl.datasets.libribrain2025.constants_utils.html">pnpl.datasets.libribrain2025.constants_utils</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Contribute</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="development.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="code_of_conduct.html">Code of Conduct</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/LibriBrain_Competition_Speech_Detection.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Speech Detection (LibriBrain)</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-up-dependencies">Setting up dependencies</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#understanding-the-dataset">Understanding the dataset</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-the-data">Exploring the data</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#hdf5-files">HDF5 files</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#labels">Labels</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#understanding-the-task">Understanding the task</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#in-this-notebook">In this notebook‚Ä¶</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#training-a-model">Training a model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#preparing-the-data">Preparing the data</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#simplifying-the-prediction-task">Simplifying the prediction task</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#sensor-masking">Sensor masking</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#actual-training-loop">Actual training loop</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluating-the-model">Evaluating the model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#that-s-it">That‚Äôs it! ü•≥</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <div style="padding:1rem; border-left:6px solid #6b7280; background:#f8fafc; border-radius:6px; margin-bottom:1rem;">
  <p style="margin:0 0 .5rem 0; font-weight:700;">Recommended: run in Google Colab with a free GPU</p>
  <ul style="margin:.25rem 0 .75rem 1.25rem;">
    <li>In Colab: Runtime ‚Üí Change runtime type ‚Üí <b>GPU</b></li>
  </ul>
  <a href="https://colab.research.google.com/github/neural-processing-lab/2025-libribrain-competition/blob/main/static/colabs/LibriBrain_Competition_Speech_Detection.ipynb" target="_blank" rel="noopener">
    <img src="https://colab.research.google.com/github/neural-processing-lab/2025-libribrain-competition/blob/main/static/colabs/LibriBrain_Competition_Speech_Detection.ipynb" alt="Open in Colab"/>
  </a>
</div><section class="tex2jax_ignore mathjax_ignore" id="speech-detection-libribrain">
<h1>Speech Detection (LibriBrain)<a class="headerlink" href="#speech-detection-libribrain" title="Link to this heading">#</a></h1>
<p>Welcome! This Notebook is the entrypoint into the <a class="reference external" href="https://libribrain.com/">LibriBrain</a> competition hosted by the <a class="reference internal" href="#pnpl.robots.ox.ac.uk/"><span class="xref myst">PNPL</span></a> at NeurIPS 2025.</p>
<p>It will walk you through</p>
<ol class="arabic simple">
<li><p>setting up all necessary dependencies,</p></li>
<li><p>downloading training data, and</p></li>
<li><p>training a scaled down version of the simplest track of the competition</p></li>
</ol>
<p>It is fully functional in the Colab Free Tier, though training will of course be faster with more GPU horsepower. With default settings on a <code class="docutils literal notranslate"><span class="pre">T4</span></code> instance, the main training run should take no more than 45 minutes.</p>
<p>In case of any questions or problems, please get in touch through <a class="reference external" href="https://neural-processing-lab.github.io/2025-libribrain-competition/links/discord">our Discord server</a>.</p>
<p>‚ö†Ô∏è <strong>Notes</strong>:</p>
<ul class="simple">
<li><p>If you want to speed up model training, <strong>make sure you are on a GPU runtime by clicking Runtime -&gt; Change runtime type</strong>. TPU acceleration is currently not supported.</p></li>
<li><p>We have only comprehensively validated the notebook to work on Colab and Unix. Your experience in other environments (e.g., Windows) may vary.</p></li>
</ul>
<section id="setting-up-dependencies">
<h2>Setting up dependencies<a class="headerlink" href="#setting-up-dependencies" title="Link to this heading">#</a></h2>
<p>Run the code below <em>as is</em>. It will download all required dependencies, including our own <a class="reference external" href="https://pypi.org/project/pnpl/">PNPL</a> package. On Windows, you might have to restart your Kernel after the installation has finished.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Install additional depdendencies</span>
<span class="o">%</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">q</span> <span class="n">lightning</span> <span class="n">torchmetrics</span> <span class="n">scikit</span><span class="o">-</span><span class="n">learn</span> <span class="n">plotly</span> <span class="n">ipywidgets</span> <span class="n">pnpl</span>

<span class="c1"># Set up base path for dataset and related files (base_path is assumed to be set in the cells below!)</span>
<span class="n">base_path</span> <span class="o">=</span> <span class="s2">&quot;./libribrain&quot;</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">google.colab</span>  <span class="c1"># This module is only available in Colab.</span>
    <span class="n">in_colab</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">base_path</span> <span class="o">=</span> <span class="s2">&quot;/content&quot;</span>  <span class="c1"># This is the folder displayed in the Colab sidebar</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">in_colab</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="understanding-the-dataset">
<h2>Understanding the dataset<a class="headerlink" href="#understanding-the-dataset" title="Link to this heading">#</a></h2>
<p>What makes the LibriBrain interesting is that it is <em>deep</em> and not just <em>big</em>. It contains data from a single person listening to stories from the <a class="reference external" href="https://en.wikipedia.org/wiki/Canon_of_Sherlock_Holmes">canon of Sherlock Holmes</a> by Sir Arthur Doyle for around <strong>50 hours</strong>, giving us plenty of data to work with.</p>
<p>Let‚Äôs first set up the smallest possible dataset, using only a single session of a single task. Doing this will automatically download the necessary data. We‚Äôre using the following parameters:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">data_path</span></code>: Local path where the MEG data and event files should be stored</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">include_run_keys</span></code>: ‚ÄúBIDS-like‚Äù specification of which data you wish to load. Expects a list of tuples like <em>(subject, session, task, run)</em></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tmin</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">tmax</span></code>: How long we want one input into the model to be in seconds. For 0.8s at our sampling rate of 250Hz, this amounts to 250*0.8=200 samples.</p></li>
</ul>
<p>Note: The <code class="docutils literal notranslate"><span class="pre">LibriBrainSpeech</span></code> dataset will provide simple speech/silence labels. For more complex tasks like phoneme classification, we also provide the <code class="docutils literal notranslate"><span class="pre">LibriBrainPhoneme</span></code> dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pnpl.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">LibriBrainSpeech</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span>


<span class="c1"># We&#39;re only using data from</span>
<span class="c1"># - subject 0 (all LibriBrain data is from the same subject!)</span>
<span class="c1"># - session 1 (this represents chapter of the book)</span>
<span class="c1"># - task &quot;Sherlock1&quot; (meaning the first book of the cannon)</span>
<span class="c1"># - run 1 (collected in the first run)</span>
<span class="c1"># for now.</span>
<span class="c1"># We&#39;ll load more later!</span>
<span class="n">example_data</span> <span class="o">=</span> <span class="n">LibriBrainSpeech</span><span class="p">(</span>
  <span class="n">data_path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_path</span><span class="si">}</span><span class="s2">/data/&quot;</span><span class="p">,</span>
  <span class="n">include_run_keys</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;0&quot;</span><span class="p">,</span><span class="s2">&quot;1&quot;</span><span class="p">,</span><span class="s2">&quot;Sherlock1&quot;</span><span class="p">,</span><span class="s2">&quot;1&quot;</span><span class="p">)],</span>
  <span class="n">tmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
  <span class="n">tmax</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
  <span class="n">preload_files</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span>

<span class="c1"># Conditionally set num_workers to avoid multiprocessing issues (try increasing if performance is problematic)</span>
<span class="n">num_workers</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">in_colab</span> <span class="k">else</span> <span class="mi">0</span>

<span class="n">example_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">example_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of samples:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">example_data</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<section id="exploring-the-data">
<h3>Exploring the data<a class="headerlink" href="#exploring-the-data" title="Link to this heading">#</a></h3>
<p>Before we start <em>doing</em> anything, let‚Äôs explore the dataset. If you check the path set as <code class="docutils literal notranslate"><span class="pre">data_path</span></code> above (<code class="docutils literal notranslate"><span class="pre">/content/data</span></code> in Colab by default), you will see a long list of two types of files</p>
<ul class="simple">
<li><p><strong>MEG data</strong>: Larger files ending in <a class="reference external" href="https://www.hdfgroup.org/solutions/hdf5/"><code class="docutils literal notranslate"><span class="pre">.h5</span></code></a>, these contain the MEG data for each session. The data has been preprocessed.</p></li>
<li><p><strong>Event files</strong>: Ending in <a class="reference external" href="https://en.wikipedia.org/wiki/Tab-separated_values"><code class="docutils literal notranslate"><span class="pre">.tsv</span></code></a>, these contain information about which words/phonemes occur with the corresponding timestamps. For our purposes, they function as labels.</p></li>
</ul>
<section id="hdf5-files">
<h4>HDF5 files<a class="headerlink" href="#hdf5-files" title="Link to this heading">#</a></h4>
<p>Let‚Äôs start with the HDF5 files.
First, let‚Äôs take a look at the actual file name of what we just downloaded:</p>
<p><code class="docutils literal notranslate"><span class="pre">sub-0_ses-1_task-Sherlock1_run-1_proc-bads+headpos+sss+notch+bp+ds_meg.h5</span></code></p>
<p>This can seem daunting at first, so let‚Äôs break it down:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">sub-0</span></code>: The data comes from Subject 1</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ses-1</span></code>: and has been collected during session 1.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">task-Sherlock1</span></code>: It contains data related to the Sherlock1 task,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">run-1</span></code> specifically the first run of it</p></li>
</ul>
<p>The remaining part indicates the preprocessing we have performed:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">bads</span></code>: Removal of <a class="reference external" href="https://mne.tools/stable/auto_tutorials/preprocessing/15_handling_bad_channels.html">bad channels</a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">headpos</span></code>: Adjusted the signal to <a class="reference external" href="https://mne.tools/stable/auto_tutorials/preprocessing/60_maxwell_filtering_sss.html">compensate for head movement</a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sss</span></code>: <a class="reference external" href="https://mne.tools/stable/auto_tutorials/preprocessing/60_maxwell_filtering_sss.html">Signal-space separation</a>, used to isolate signals from inside the head from those coming from outside it</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">notch</span></code>: <a class="reference external" href="https://mne.tools/stable/generated/mne.filter.notch_filter.html">Notch filtering</a>, used to eliminate specific frequency noise (e.g., from the electrical grid)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bp</span></code>: Bandpass <a class="reference external" href="https://mne.tools/1.8/auto_tutorials/preprocessing/30_filtering_resampling.html">filtering</a>, used to isolate the frequency range of interest</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ds</span></code>: <a class="reference external" href="https://mne.tools/stable/generated/mne.filter.resample.html">Downsampling</a>, reducing the data‚Äôs sampling rate for easier handling</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">meg</span></code> The modality of the brain data. The LibriBrain data was collected using <a class="reference external" href="https://en.wikipedia.org/wiki/Magnetoencephalography">magnetoencephalography</a>.</p></li>
</ul>
<p>The data structure in the file is relatively straightforward:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">h5py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="c1"># This is the file we&#39;ll look at</span>
<span class="n">hdf5_file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_path</span><span class="si">}</span><span class="s2">/data/Sherlock1/derivatives/serialised/sub-0_ses-1_task-Sherlock1_run-1_proc-bads+headpos+sss+notch+bp+ds_meg.h5&quot;</span>

<span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">hdf5_file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== HDF5 File Structure ===&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">print_structure</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="n">obj_type</span> <span class="o">=</span> <span class="s2">&quot;Group&quot;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;Dataset&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">obj_type</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">visititems</span><span class="p">(</span><span class="n">print_structure</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Details for &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; ---&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Type:&quot;</span><span class="p">,</span> <span class="s2">&quot;Group&quot;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;Dataset&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shape:&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Data type:&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][:]</span>   <span class="c1"># &#39;data&#39; holds the actual recorded MEG sensor values</span>
    <span class="n">times</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;times&quot;</span><span class="p">][:]</span> <span class="c1"># &#39;times&#39; holds the corresponding time stamps</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Statistics for &#39;data&#39; dataset ---&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Minimum value:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Maximum value:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mean value:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Standard deviation:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">As you can see, timestamp is 0.004 seconds from the previous:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">times</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;This equals a polling rate of 250 Hz.&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">And these are the first first 10 time samples from the first 5 channels of the data:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="mi">5</span><span class="p">,</span> <span class="p">:</span><span class="mi">10</span><span class="p">])</span>


<span class="nb">print</span><span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>Next, let‚Äôs get a visual overview over the locations of the sensors and their corresponding values.
Using the settings at the bottom, we can explore the different timestamps and inspect the sensors activity over time.
We can choose to use the sensors‚Äôs absolute values (using a logarithmic scale to deal with some outliers) or switch to a normalized version in which the sensor‚Äôs values are normalized for each sensor.</p>
<p>‚ö†Ô∏è <strong>Note</strong>: In reality, we have sets of three sensors sharing the same location (306 sensors at 102 locations), each capturing a different axis of the magnetic field. For the sake of the visualization below, the second and third sensor at the same location are offset slightly (as they would be invisible otherwise).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">h5py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.graph_objects</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">go</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ipywidgets</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">widgets</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ipywidgets</span><span class="w"> </span><span class="kn">import</span> <span class="n">VBox</span><span class="p">,</span> <span class="n">HBox</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span><span class="o">,</span><span class="w"> </span><span class="nn">requests</span>


<span class="c1"># Enable custom widgets (in Colab)</span>
<span class="k">if</span> <span class="n">in_colab</span><span class="p">:</span>
  <span class="kn">from</span><span class="w"> </span><span class="nn">google.colab</span><span class="w"> </span><span class="kn">import</span> <span class="n">output</span>
  <span class="n">output</span><span class="o">.</span><span class="n">enable_custom_widget_manager</span><span class="p">()</span>


<span class="c1"># Download sensor locations JSON</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="s2">&quot;sensor_xyz.json&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;https://neural-processing-lab.github.io/2025-libribrain-competition/sensor_xyz.json&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloaded sensor_xyz.json&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File exists, skipping download.&quot;</span><span class="p">)</span>


<span class="c1"># Load sensor positions from exported JSON file</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
    <span class="n">sensor_xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span>
<span class="n">n_channels</span> <span class="o">=</span> <span class="n">sensor_xyz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Sampling frequency</span>
<span class="n">sfreq</span> <span class="o">=</span> <span class="mi">250</span>

<span class="c1"># Load the MEG data and timestamps from the new HDF5 file</span>
<span class="n">hdf5_file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_path</span><span class="si">}</span><span class="s2">/data/Sherlock1/derivatives/serialised/sub-0_ses-1_task-Sherlock1_run-1_proc-bads+headpos+sss+notch+bp+ds_meg.h5&quot;</span>
<span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">hdf5_file_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">raw_data</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][:]</span>
    <span class="n">times</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;times&quot;</span><span class="p">][:]</span>

<span class="c1"># Determine total duration from the timestamps</span>
<span class="n">total_time_sec</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">n_timepoints</span> <span class="o">=</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data shape: </span><span class="si">{</span><span class="n">raw_data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total duration: </span><span class="si">{</span><span class="n">total_time_sec</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>

<span class="c1"># Precompute per-sensor normalization (avoid division by zero)</span>
<span class="n">sensor_mins</span> <span class="o">=</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sensor_maxs</span> <span class="o">=</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sensor_ranges</span> <span class="o">=</span> <span class="n">sensor_maxs</span> <span class="o">-</span> <span class="n">sensor_mins</span>
<span class="n">sensor_ranges</span><span class="p">[</span><span class="n">sensor_ranges</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-12</span>  <span class="c1"># Handle flat channels</span>

<span class="c1"># Create a normalized version (each sensor scaled independently to 0..1)</span>
<span class="n">norm_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">raw_data</span> <span class="o">-</span> <span class="n">sensor_mins</span><span class="p">)</span> <span class="o">/</span> <span class="n">sensor_ranges</span>

<span class="c1"># Compute raw data limits for color mapping</span>
<span class="n">global_raw_min</span> <span class="o">=</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
<span class="n">global_raw_max</span> <span class="o">=</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

<span class="c1"># Define the filtered sensor indices (zero-indexed)</span>
<span class="n">filtered_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">18</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">138</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">142</span><span class="p">,</span> <span class="mi">143</span><span class="p">,</span> <span class="mi">145</span><span class="p">,</span>
                             <span class="mi">146</span><span class="p">,</span> <span class="mi">147</span><span class="p">,</span> <span class="mi">149</span><span class="p">,</span> <span class="mi">175</span><span class="p">,</span> <span class="mi">176</span><span class="p">,</span> <span class="mi">177</span><span class="p">,</span> <span class="mi">179</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">198</span><span class="p">,</span> <span class="mi">271</span><span class="p">,</span> <span class="mi">272</span><span class="p">,</span> <span class="mi">275</span><span class="p">])</span>
<span class="c1"># (In case any index is out of bounds, restrict to valid indices)</span>
<span class="n">filtered_indices</span> <span class="o">=</span> <span class="n">filtered_indices</span><span class="p">[</span><span class="n">filtered_indices</span> <span class="o">&lt;</span> <span class="n">n_channels</span><span class="p">]</span>
<span class="n">filtered_raw_min</span> <span class="o">=</span> <span class="n">raw_data</span><span class="p">[</span><span class="n">filtered_indices</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">global_raw_min</span>
<span class="n">filtered_raw_max</span> <span class="o">=</span> <span class="n">raw_data</span><span class="p">[</span><span class="n">filtered_indices</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">global_raw_max</span>

<span class="c1"># Compute fixed axes ranges from sensor positions.</span>
<span class="n">x_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">sensor_xyz</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">sensor_xyz</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>
<span class="n">y_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">sensor_xyz</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">sensor_xyz</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>
<span class="n">z_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">sensor_xyz</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">sensor_xyz</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>

<span class="c1"># --- Non-linear transformation function ---</span>
<span class="k">def</span><span class="w"> </span><span class="nf">non_linear_transform</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1e-11</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies a sign-preserving log transform:</span>
<span class="sd">      transformed = sign(x) * log10(1 + |x|/scale)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">scale</span><span class="p">)</span>

<span class="c1"># --- Jitter duplicates helper ---</span>
<span class="k">def</span><span class="w"> </span><span class="nf">jitter_duplicates</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">jitter</span><span class="o">=</span><span class="mf">2e-3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds a small offset to duplicate sensor coordinates.</span>
<span class="sd">    Sensors with identical coordinates are slightly displaced so they remain distinct.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">jittered_xyz</span> <span class="o">=</span> <span class="n">xyz</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">point</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xyz</span><span class="p">):</span>
        <span class="c1"># Round the coordinates to avoid floating-point precision issues</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">6</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
            <span class="c1"># Calculate an offset based on how many times the coordinate was seen</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">jitter</span> <span class="o">*</span> <span class="n">seen</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">jittered_xyz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">point</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">offset</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">offset</span><span class="p">])</span>
            <span class="n">seen</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">seen</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">jittered_xyz</span>

<span class="c1"># --- Utility function to select data based on mode and sensor filter ---</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_current_data</span><span class="p">(</span><span class="n">time_idx</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">sensor_filter</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Normalized&#39;</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">norm_data</span>
        <span class="n">cmin</span><span class="p">,</span> <span class="n">cmax</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Raw mode with non-linear transform</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">non_linear_transform</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1e-11</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sensor_filter</span> <span class="o">==</span> <span class="s1">&#39;Mask only&#39;</span><span class="p">:</span>
            <span class="n">cmin</span> <span class="o">=</span> <span class="n">non_linear_transform</span><span class="p">(</span><span class="n">filtered_raw_min</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1e-11</span><span class="p">)</span>
            <span class="n">cmax</span> <span class="o">=</span> <span class="n">non_linear_transform</span><span class="p">(</span><span class="n">filtered_raw_max</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1e-11</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmin</span> <span class="o">=</span> <span class="n">non_linear_transform</span><span class="p">(</span><span class="n">global_raw_min</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1e-11</span><span class="p">)</span>
            <span class="n">cmax</span> <span class="o">=</span> <span class="n">non_linear_transform</span><span class="p">(</span><span class="n">global_raw_max</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1e-11</span><span class="p">)</span>

    <span class="c1"># Determine sensor indices based on the sensor filter.</span>
    <span class="k">if</span> <span class="n">sensor_filter</span> <span class="o">==</span> <span class="s1">&#39;Mask only&#39;</span><span class="p">:</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">filtered_indices</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_channels</span><span class="p">)</span>

    <span class="n">current_values</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="n">time_idx</span><span class="p">]</span>
    <span class="c1"># Apply jitter to sensor positions to avoid overlap when coordinates are identical</span>
    <span class="n">current_xyz</span> <span class="o">=</span> <span class="n">jitter_duplicates</span><span class="p">(</span><span class="n">sensor_xyz</span><span class="p">[</span><span class="n">indices</span><span class="p">])</span>

    <span class="c1"># Compute per-sensor min and max values for display.</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Normalized&#39;</span><span class="p">:</span>
        <span class="n">sensor_mins_disp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">current_values</span><span class="p">)</span>
        <span class="n">sensor_maxs_disp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">current_values</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sensor_mins_disp</span> <span class="o">=</span> <span class="n">non_linear_transform</span><span class="p">(</span><span class="n">sensor_mins</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()[</span><span class="n">indices</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1e-11</span><span class="p">)</span>
        <span class="n">sensor_maxs_disp</span> <span class="o">=</span> <span class="n">non_linear_transform</span><span class="p">(</span><span class="n">sensor_maxs</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()[</span><span class="n">indices</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1e-11</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">current_xyz</span><span class="p">,</span> <span class="n">current_values</span><span class="p">,</span> <span class="n">sensor_mins_disp</span><span class="p">,</span> <span class="n">sensor_maxs_disp</span><span class="p">,</span> <span class="n">cmin</span><span class="p">,</span> <span class="n">cmax</span>

<span class="c1"># --- Helper function to create hover text ---</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_hover_text</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">current_vals</span><span class="p">,</span> <span class="n">mins</span><span class="p">,</span> <span class="n">maxs</span><span class="p">):</span>
    <span class="n">texts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">current_vals</span><span class="p">)):</span>
        <span class="n">texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;X: </span><span class="si">{</span><span class="n">xyz</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&lt;br&gt;&quot;</span>
                     <span class="sa">f</span><span class="s2">&quot;Y: </span><span class="si">{</span><span class="n">xyz</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&lt;br&gt;&quot;</span>
                     <span class="sa">f</span><span class="s2">&quot;Z: </span><span class="si">{</span><span class="n">xyz</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&lt;br&gt;&quot;</span>
                     <span class="sa">f</span><span class="s2">&quot;Current: </span><span class="si">{</span><span class="n">current_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&lt;br&gt;&quot;</span>
                     <span class="sa">f</span><span class="s2">&quot;Min: </span><span class="si">{</span><span class="n">mins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&lt;br&gt;&quot;</span>
                     <span class="sa">f</span><span class="s2">&quot;Max: </span><span class="si">{</span><span class="n">maxs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">texts</span>

<span class="c1"># --- Create the initial plot ---</span>
<span class="n">initial_time_idx</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">initial_mode</span> <span class="o">=</span> <span class="s1">&#39;Normalized&#39;</span>
<span class="n">initial_filter</span> <span class="o">=</span> <span class="s1">&#39;All&#39;</span>
<span class="n">current_xyz</span><span class="p">,</span> <span class="n">current_values</span><span class="p">,</span> <span class="n">sensor_mins_disp</span><span class="p">,</span> <span class="n">sensor_maxs_disp</span><span class="p">,</span> <span class="n">cmin</span><span class="p">,</span> <span class="n">cmax</span> <span class="o">=</span> <span class="n">get_current_data</span><span class="p">(</span><span class="n">initial_time_idx</span><span class="p">,</span> <span class="n">initial_mode</span><span class="p">,</span> <span class="n">initial_filter</span><span class="p">)</span>
<span class="n">hover_text</span> <span class="o">=</span> <span class="n">create_hover_text</span><span class="p">(</span><span class="n">current_xyz</span><span class="p">,</span> <span class="n">current_values</span><span class="p">,</span> <span class="n">sensor_mins_disp</span><span class="p">,</span> <span class="n">sensor_maxs_disp</span><span class="p">)</span>

<span class="n">scatter</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">current_xyz</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="n">y</span><span class="o">=</span><span class="n">current_xyz</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="n">z</span><span class="o">=</span><span class="n">current_xyz</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
    <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span>
    <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">current_values</span><span class="p">,</span>
        <span class="n">colorscale</span><span class="o">=</span><span class="s1">&#39;Viridis&#39;</span><span class="p">,</span>
        <span class="n">cmin</span><span class="o">=</span><span class="n">cmin</span><span class="p">,</span>
        <span class="n">cmax</span><span class="o">=</span><span class="n">cmax</span><span class="p">,</span>
        <span class="n">colorbar</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Amplitude&quot;</span><span class="p">)</span>
    <span class="p">),</span>
    <span class="n">text</span><span class="o">=</span><span class="n">hover_text</span><span class="p">,</span>
    <span class="n">hoverinfo</span><span class="o">=</span><span class="s1">&#39;text&#39;</span>
<span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">FigureWidget</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">scatter</span><span class="p">],</span>
    <span class="n">layout</span><span class="o">=</span><span class="n">go</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span>
        <span class="n">height</span><span class="o">=</span><span class="mi">650</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;LibriBrain MEG data - </span><span class="si">{</span><span class="n">initial_mode</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">initial_filter</span><span class="si">}</span><span class="s2"> - Time: </span><span class="si">{</span><span class="n">times</span><span class="p">[</span><span class="n">initial_time_idx</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span>
        <span class="n">scene</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="nb">range</span><span class="o">=</span><span class="n">x_range</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;X Position&quot;</span><span class="p">),</span>
            <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="nb">range</span><span class="o">=</span><span class="n">y_range</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Y Position&quot;</span><span class="p">),</span>
            <span class="n">zaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="nb">range</span><span class="o">=</span><span class="n">z_range</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Z Position&quot;</span><span class="p">),</span>
            <span class="n">aspectmode</span><span class="o">=</span><span class="s2">&quot;cube&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="c1"># --- Create widgets for interactivity ---</span>
<span class="n">time_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span>
    <span class="n">value</span><span class="o">=</span><span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="nb">min</span><span class="o">=</span><span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="nb">max</span><span class="o">=</span><span class="n">times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">step</span><span class="o">=</span><span class="mf">0.004</span><span class="p">,</span>  <span class="c1"># Since polling rate is 250 Hz</span>
    <span class="n">continuous_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">readout_format</span><span class="o">=</span><span class="s1">&#39;.3f&#39;</span>
<span class="p">)</span>

<span class="n">raw_time_input</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatText</span><span class="p">(</span>
    <span class="n">value</span><span class="o">=</span><span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">layout</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s1">&#39;160px&#39;</span><span class="p">),</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Time (s):&quot;</span>
<span class="p">)</span>

<span class="n">norm_dropdown</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span>
    <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Normalized&#39;</span><span class="p">,</span> <span class="s1">&#39;Raw&#39;</span><span class="p">],</span>
    <span class="n">value</span><span class="o">=</span><span class="n">initial_mode</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Value Type:&#39;</span>
<span class="p">)</span>

<span class="n">filter_dropdown</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span>
    <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;All&#39;</span><span class="p">,</span> <span class="s1">&#39;Mask only&#39;</span><span class="p">],</span>
    <span class="n">value</span><span class="o">=</span><span class="n">initial_filter</span><span class="p">,</span>
    <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;description_width&#39;</span><span class="p">:</span> <span class="s1">&#39;150px&#39;</span><span class="p">},</span>
    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Displayed sensors:&#39;</span>
<span class="p">)</span>

<span class="c1"># --- Synchronize the slider and raw time input ---</span>
<span class="k">def</span><span class="w"> </span><span class="nf">on_slider_change</span><span class="p">(</span><span class="n">change</span><span class="p">):</span>
    <span class="n">new_val</span> <span class="o">=</span> <span class="n">change</span><span class="p">[</span><span class="s1">&#39;new&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">raw_time_input</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="n">new_val</span><span class="p">:</span>
        <span class="n">raw_time_input</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">new_val</span>

<span class="k">def</span><span class="w"> </span><span class="nf">on_raw_time_change</span><span class="p">(</span><span class="n">change</span><span class="p">):</span>
    <span class="n">new_val</span> <span class="o">=</span> <span class="n">change</span><span class="p">[</span><span class="s1">&#39;new&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">time_slider</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="n">new_val</span><span class="p">:</span>
        <span class="n">time_slider</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">new_val</span>

<span class="n">time_slider</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">on_slider_change</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
<span class="n">raw_time_input</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">on_raw_time_change</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>

<span class="c1"># --- Callback to update the plot ---</span>
<span class="k">def</span><span class="w"> </span><span class="nf">update_plot</span><span class="p">(</span><span class="n">change</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">time_slider</span><span class="o">.</span><span class="n">value</span>
    <span class="c1"># Find the closest index using the sampling frequency:</span>
    <span class="n">time_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="n">sfreq</span><span class="p">)),</span> <span class="n">n_timepoints</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="n">norm_dropdown</span><span class="o">.</span><span class="n">value</span>
    <span class="n">sensor_filter</span> <span class="o">=</span> <span class="n">filter_dropdown</span><span class="o">.</span><span class="n">value</span>
    <span class="n">current_xyz</span><span class="p">,</span> <span class="n">current_values</span><span class="p">,</span> <span class="n">sensor_mins_disp</span><span class="p">,</span> <span class="n">sensor_maxs_disp</span><span class="p">,</span> <span class="n">cmin</span><span class="p">,</span> <span class="n">cmax</span> <span class="o">=</span> <span class="n">get_current_data</span><span class="p">(</span><span class="n">time_idx</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">sensor_filter</span><span class="p">)</span>
    <span class="n">hover_text</span> <span class="o">=</span> <span class="n">create_hover_text</span><span class="p">(</span><span class="n">current_xyz</span><span class="p">,</span> <span class="n">current_values</span><span class="p">,</span> <span class="n">sensor_mins_disp</span><span class="p">,</span> <span class="n">sensor_maxs_disp</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">fig</span><span class="o">.</span><span class="n">batch_update</span><span class="p">():</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">current_xyz</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">current_xyz</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">current_xyz</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">marker</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">current_values</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">marker</span><span class="o">.</span><span class="n">cmin</span> <span class="o">=</span> <span class="n">cmin</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">marker</span><span class="o">.</span><span class="n">cmax</span> <span class="o">=</span> <span class="n">cmax</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">hover_text</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;LibriBrain MEG data - </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">sensor_filter</span><span class="si">}</span><span class="s2"> - Time: </span><span class="si">{</span><span class="n">t</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">s&quot;</span>

<span class="n">time_slider</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">update_plot</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
<span class="n">norm_dropdown</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">update_plot</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
<span class="n">filter_dropdown</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">update_plot</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>

<span class="n">display</span><span class="p">(</span><span class="n">VBox</span><span class="p">([</span><span class="n">fig</span><span class="p">,</span> <span class="n">HBox</span><span class="p">([</span><span class="n">raw_time_input</span><span class="p">,</span> <span class="n">time_slider</span><span class="p">,</span> <span class="n">norm_dropdown</span><span class="p">,</span> <span class="n">filter_dropdown</span><span class="p">])]))</span>
</pre></div>
</div>
</div>
</div>
<p>You might have noticed that we have a lot more data points than samples reported by the dataset.</p>
<p>This is because the dataset considers a single sample to be the collection of data points reported in the timeframe from <code class="docutils literal notranslate"><span class="pre">tmin</span></code> to <code class="docutils literal notranslate"><span class="pre">tmax</span></code>.
In our case, with a sampling rate of 250Hz, <code class="docutils literal notranslate"><span class="pre">tmin</span></code> of 0.0s and <code class="docutils literal notranslate"><span class="pre">tmax</span></code> of 0.8s, we end up with 250 * 0.8 = 200 data points / timesteps per sample.</p>
<p>While we‚Äôre not doing so in this Colab, you can use this to counter some of the imbalance of the data. Using the <code class="docutils literal notranslate"><span class="pre">oversample_silence_jitter</span></code> parameter in the dataset, you can ‚Äúshift‚Äù the sampling window slower over periods of silence. A good value we found is 70 steps per sample instead of 200 (<code class="docutils literal notranslate"><span class="pre">oversample_silence_jitter=70</span></code>).</p>
</section>
<section id="labels">
<h4>Labels<a class="headerlink" href="#labels" title="Link to this heading">#</a></h4>
<p>Next, let‚Äôs explore the labels. As you can see below, the data includes overlapping phoneme and word labels for each period of heard speech.
For the speech detection task, we only care about differentiating between <em>speech</em> (time where there is a ‚Äúword‚Äù label) and <em>non-speech</em> (time where there is a ‚Äúsilence‚Äù label)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="k">def</span><span class="w"> </span><span class="nf">explore_tsv</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_series</span><span class="p">(</span><span class="n">series</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">series</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="s1">&#39;int64&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Series(dtype=</span><span class="si">{</span><span class="n">series</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">, min=</span><span class="si">{</span><span class="n">series</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;max=</span><span class="si">{</span><span class="n">series</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">, mean=</span><span class="si">{</span><span class="n">series</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;std=</span><span class="si">{</span><span class="n">series</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">series</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">:</span>
            <span class="n">unique_values</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Series(dtype=</span><span class="si">{</span><span class="n">series</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">, unique_values=</span><span class="si">{</span><span class="n">unique_values</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Series(dtype=</span><span class="si">{</span><span class="n">series</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Structure of TSV file:&quot;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Number of rows: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of columns: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Columns and Data Types:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">format_series</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sample Data:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">20</span><span class="p">))</span>

<span class="n">tsv_file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_path</span><span class="si">}</span><span class="s2">/data/Sherlock1/derivatives/events/sub-0_ses-1_task-Sherlock1_run-1_events.tsv&quot;</span>
<span class="n">explore_tsv</span><span class="p">(</span><span class="n">tsv_file_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="understanding-the-task">
<h2>Understanding the task<a class="headerlink" href="#understanding-the-task" title="Link to this heading">#</a></h2>
<p>Now that we understand what the data looks like, let‚Äôs understand what task we‚Äôre trying to solve.</p>
<p>This year, the LibriBrain competition consists of two tracks:</p>
<ol class="arabic simple">
<li><p><strong>Speech detection</strong>: Classifying which parts of the provided MEG data are speech</p></li>
<li><p><strong>Phoneme classification</strong>: Predicting which phonemes are heard for the provided MEG data</p></li>
</ol>
<p>Inspired by <a class="reference external" href="https://www.cs.utexas.edu/~eunsol/courses/data/bitter_lesson.pdf">Sutton‚Äôs Bitter Lesson</a> (and to keep the competition as accessible as possible), there are two variants for the two tracks:</p>
<ul class="simple">
<li><p><em>Standard</em>: Training data must be limited to the <code class="docutils literal notranslate"><span class="pre">Sherlock</span></code> data provided in the LibriBrain dataset</p></li>
<li><p><em>Extended</em>: Everything goes - you may use whatever data you wish to.</p></li>
</ul>
<section id="in-this-notebook">
<h3>In this notebook‚Ä¶<a class="headerlink" href="#in-this-notebook" title="Link to this heading">#</a></h3>
<p>‚Ä¶ we will only work on the <em>standard</em> variant of the speech detection task. In fact, we‚Äôll only use a portion of the LibriBrain data.</p>
<p>As you might expect, we‚Äôll be working with two output classes</p>
<ul class="simple">
<li><p>Speech</p></li>
<li><p>Not Speech</p></li>
</ul>
<p>which means we will be building a binary classifier. Now, let‚Äôs take a look at what this prediction task looks like in practice:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">h5py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mne</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_info</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load_meg_data</span><span class="p">(</span><span class="n">hdf5_file_path</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">hdf5_file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">raw_data</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][:]</span>
        <span class="n">times</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">][:]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sfreq</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">dt</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not enough time points in &#39;times&#39; to determine sampling frequency.&quot;</span><span class="p">)</span>
    <span class="n">n_channels</span> <span class="o">=</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Create MNE Info object with default channel names.</span>
    <span class="n">channel_names</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;MEG </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s1">03d</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_channels</span><span class="p">)]</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">create_info</span><span class="p">(</span><span class="n">ch_names</span><span class="o">=</span><span class="n">channel_names</span><span class="p">,</span> <span class="n">sfreq</span><span class="o">=</span><span class="n">sfreq</span><span class="p">,</span> <span class="n">ch_types</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_channels</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">raw_data</span><span class="p">,</span> <span class="n">info</span>


<span class="k">def</span><span class="w"> </span><span class="nf">meg_label_visualization</span><span class="p">(</span><span class="n">tsv_data</span><span class="p">,</span> <span class="n">meg_raw</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show_phonemes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">apply_sensor_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combine MEG data visualization and speech/silence labels.</span>

<span class="sd">    Parameters:</span>
<span class="sd">      - tsv_data: DataFrame with timing and labeling information.</span>
<span class="sd">      - meg_raw: MEG data array (channels x samples).</span>
<span class="sd">      - info: MNE Info object containing metadata (including sampling frequency).</span>
<span class="sd">      - start_time, end_time: Time window (in seconds) to visualize.</span>
<span class="sd">      - title: Optional title for the plots.</span>
<span class="sd">      - show_phonemes: Whether to show phoneme annotations.</span>
<span class="sd">      - apply_sensor_mask: force applying the sensor mask;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># --- Optionally apply sensor mask if using filtered data ---</span>
    <span class="k">if</span> <span class="n">apply_sensor_mask</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">meg_raw</span> <span class="o">=</span> <span class="n">meg_raw</span><span class="p">[</span><span class="n">SENSORS_SPEECH_MASK</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SENSORS_SPEECH_MASK is not defined. Proceeding without sensor mask.&quot;</span><span class="p">)</span>

    <span class="c1"># --- Process TSV data to build ground-truth labels ---</span>
    <span class="n">tsv_data</span> <span class="o">=</span> <span class="n">tsv_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">tsv_data</span><span class="p">[</span><span class="s1">&#39;timemeg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tsv_data</span><span class="p">[</span><span class="s1">&#39;timemeg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">last_before</span> <span class="o">=</span> <span class="n">tsv_data</span><span class="p">[</span><span class="n">tsv_data</span><span class="p">[</span><span class="s1">&#39;timemeg&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">start_time</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">window_data</span> <span class="o">=</span> <span class="n">tsv_data</span><span class="p">[(</span><span class="n">tsv_data</span><span class="p">[</span><span class="s1">&#39;timemeg&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tsv_data</span><span class="p">[</span><span class="s1">&#39;timemeg&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">end_time</span><span class="p">)]</span>
    <span class="n">filtered_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">last_before</span><span class="p">,</span> <span class="n">window_data</span><span class="p">])</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;timemeg&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">filtered_data</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">filtered_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;timemeg&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">],</span> <span class="s1">&#39;speech_label&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]})</span>
    <span class="n">filtered_data</span><span class="p">[</span><span class="s1">&#39;speech_label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">filtered_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filtered_data</span><span class="p">[</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;word&#39;</span><span class="p">,</span> <span class="s1">&#39;phoneme&#39;</span><span class="p">]),</span> <span class="s1">&#39;speech_label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">first_value</span> <span class="o">=</span> <span class="n">filtered_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;speech_label&#39;</span><span class="p">]</span>
    <span class="n">plot_times</span> <span class="o">=</span> <span class="p">[</span><span class="n">start_time</span><span class="p">]</span>
    <span class="n">plot_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">first_value</span><span class="p">]</span>
    <span class="n">plot_times</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">filtered_data</span><span class="p">[</span><span class="s1">&#39;timemeg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="n">plot_values</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">filtered_data</span><span class="p">[</span><span class="s1">&#39;speech_label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="n">plot_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">end_time</span><span class="p">)</span>
    <span class="n">plot_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plot_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">plot_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">plot_times</span><span class="p">)</span>
    <span class="n">plot_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">plot_values</span><span class="p">)</span>

    <span class="c1"># --- Extract the MEG segment ---</span>
    <span class="n">sfreq</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;sfreq&#39;</span><span class="p">]</span>
    <span class="n">start_sample</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">start_time</span> <span class="o">*</span> <span class="n">sfreq</span><span class="p">)</span>
    <span class="n">end_sample</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">end_time</span> <span class="o">*</span> <span class="n">sfreq</span><span class="p">)</span>
    <span class="n">meg_segment</span> <span class="o">=</span> <span class="n">meg_raw</span><span class="p">[:,</span> <span class="n">start_sample</span><span class="p">:</span><span class="n">end_sample</span><span class="p">]</span>  <span class="c1"># shape: (channels, samples)</span>
    <span class="n">time_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">meg_segment</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># --- Plotting ---</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;height_ratios&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]},</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">meg_title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">: MEG Data (</span><span class="si">{</span><span class="n">start_time</span><span class="si">}</span><span class="s2">s to </span><span class="si">{</span><span class="n">end_time</span><span class="si">}</span><span class="s2">s)&quot;</span> <span class="k">if</span> <span class="n">title</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;MEG Data (</span><span class="si">{</span><span class="n">start_time</span><span class="si">}</span><span class="s2">s to </span><span class="si">{</span><span class="n">end_time</span><span class="si">}</span><span class="s2">s)&quot;</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_points</span><span class="p">,</span> <span class="n">meg_segment</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">meg_title</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Amplitude&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plot_times</span><span class="p">,</span> <span class="n">plot_values</span><span class="p">,</span> <span class="n">drawstyle</span><span class="o">=</span><span class="s1">&#39;steps-post&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Speech (1) / Silence (0)&#39;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">filtered_data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;kind&#39;</span><span class="p">])</span> <span class="ow">or</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;silence&#39;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;timemeg&#39;</span><span class="p">])</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;segment&#39;</span><span class="p">]):</span>
            <span class="k">continue</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;phoneme&#39;</span> <span class="ow">and</span> <span class="n">show_phonemes</span> <span class="ow">and</span> <span class="n">start_time</span> <span class="o">&lt;=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;timemeg&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">end_time</span><span class="p">:</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;timemeg&#39;</span><span class="p">],</span> <span class="mf">1.1</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;segment&#39;</span><span class="p">]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;word&#39;</span> <span class="ow">and</span> <span class="n">start_time</span> <span class="o">&lt;=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;timemeg&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">end_time</span><span class="p">:</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;timemeg&#39;</span><span class="p">],</span> <span class="mf">1.3</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;segment&#39;</span><span class="p">]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not plot annotation at time </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;timemeg&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Speech / Silence&#39;</span><span class="p">)</span>
    <span class="n">labels_title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">: Labels (</span><span class="si">{</span><span class="n">start_time</span><span class="si">}</span><span class="s2">s to </span><span class="si">{</span><span class="n">end_time</span><span class="si">}</span><span class="s2">s)&quot;</span> <span class="k">if</span> <span class="n">title</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;Labels (</span><span class="si">{</span><span class="n">start_time</span><span class="si">}</span><span class="s2">s to </span><span class="si">{</span><span class="n">end_time</span><span class="si">}</span><span class="s2">s)&quot;</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">labels_title</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="c1"># Define your file paths (ensure that base_path is defined or replace with actual paths)</span>
<span class="n">tsv_file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_path</span><span class="si">}</span><span class="s2">/data/Sherlock1/derivatives/events/sub-0_ses-1_task-Sherlock1_run-1_events.tsv&quot;</span>
<span class="n">hdf5_file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_path</span><span class="si">}</span><span class="s2">/data/Sherlock1/derivatives/serialised/sub-0_ses-1_task-Sherlock1_run-1_proc-bads+headpos+sss+notch+bp+ds_meg.h5&quot;</span>

<span class="c1"># Load data from TSV and HDF5 files</span>
<span class="n">tsv_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">tsv_file_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">meg_raw</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">load_meg_data</span><span class="p">(</span><span class="n">hdf5_file_path</span><span class="p">)</span>

<span class="c1"># Pure speech</span>
<span class="n">meg_label_visualization</span><span class="p">(</span><span class="n">tsv_data</span><span class="p">,</span> <span class="n">meg_raw</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="mi">182</span><span class="p">,</span> <span class="n">end_time</span><span class="o">=</span><span class="mi">183</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Pure speech&#39;</span><span class="p">)</span>

<span class="c1"># Pure silence</span>
<span class="n">meg_label_visualization</span><span class="p">(</span><span class="n">tsv_data</span><span class="p">,</span> <span class="n">meg_raw</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="mi">1095</span><span class="p">,</span> <span class="n">end_time</span><span class="o">=</span><span class="mi">1096</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Pure silence&#39;</span><span class="p">)</span>

<span class="c1"># Transition silence -&gt; speech</span>
<span class="n">meg_label_visualization</span><span class="p">(</span><span class="n">tsv_data</span><span class="p">,</span> <span class="n">meg_raw</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="mi">55</span><span class="p">,</span> <span class="n">end_time</span><span class="o">=</span><span class="mi">56</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Transition silence -&gt; speech&#39;</span><span class="p">)</span>

<span class="c1"># Transition speech -&gt; silence</span>
<span class="n">meg_label_visualization</span><span class="p">(</span><span class="n">tsv_data</span><span class="p">,</span> <span class="n">meg_raw</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="mi">953</span><span class="p">,</span> <span class="n">end_time</span><span class="o">=</span><span class="mi">954</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Transition speech -&gt; silence&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>While we are only doing a binary classification (speech/non-speech), there are actually four types of signals that might be interesting to look at:</p>
<ul class="simple">
<li><p>Pure speech</p></li>
<li><p>Pure silence</p></li>
<li><p>Transition from silence to speech</p></li>
<li><p>Transition from speech to silence</p></li>
</ul>
<p>Above, you can see examples of those types taken from the training data.</p>
<p>Note that you can opt into showing individual phonemes by setting <code class="docutils literal notranslate"><span class="pre">show_phonemes=True</span></code> for each of these.</p>
</section>
</section>
<section id="training-a-model">
<h2>Training a model<a class="headerlink" href="#training-a-model" title="Link to this heading">#</a></h2>
<p>Now that we understand both the data and the speech detection task, let‚Äôs go forward with arranging the data and training our speech detection model.</p>
<section id="preparing-the-data">
<h3>Preparing the data<a class="headerlink" href="#preparing-the-data" title="Link to this heading">#</a></h3>
<p>First, let‚Äôs set up proper dataloaders with more training data.</p>
<p>For the sake of simplicity (and to speed things up), we will only work with the first and second book, ‚ÄúA Study in Scarlet‚Äù (referred to as <code class="docutils literal notranslate"><span class="pre">Sherlock1</span></code>) and ‚ÄúThe Sign of the Four‚Äù (referred to as <code class="docutils literal notranslate"><span class="pre">Sherlock2</span></code>) in this Colab. For the competition, you can adapt the cell below to load the rest of the dataset, though doing so may not be feasible within the Google Colab free tier.</p>
<p>In our case, since <code class="docutils literal notranslate"><span class="pre">Sherlock1</span></code> consists of 12 sessions in total, we‚Äôll use</p>
<ul class="simple">
<li><p>sessions 1 through 10 for training,</p></li>
<li><p>session 11 for validation, and</p></li>
<li><p>session 12 as a test set.</p></li>
</ul>
<p>We‚Äôll also use all 13 sessions of <code class="docutils literal notranslate"><span class="pre">Sherlock2</span></code> as additional training data.</p>
<p>From this point forward, you could theoretically take the sensor data and throw it directly into your favorite model architecture.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pnpl.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">LibriBrainSpeech</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span>

<span class="c1"># Conditionally set num_workers to avoid multiprocessing issues (try increasing if performance is problematic)</span>
<span class="n">num_workers</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">in_colab</span> <span class="k">else</span> <span class="mi">0</span>

<span class="c1"># For training, we&#39;ll use sessions 1-10 of Sherlock1 and 1-13 of Sherlock2</span>
<span class="n">train_run_keys</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;0&quot;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="s2">&quot;Sherlock1&quot;</span><span class="p">,</span><span class="s2">&quot;1&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[(</span><span class="s2">&quot;0&quot;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="s2">&quot;Sherlock2&quot;</span><span class="p">,</span><span class="s2">&quot;1&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span><span class="o">!=</span><span class="mi">2</span><span class="p">]</span>
<span class="n">train_data</span> <span class="o">=</span> <span class="n">LibriBrainSpeech</span><span class="p">(</span>
  <span class="n">data_path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_path</span><span class="si">}</span><span class="s2">/data/&quot;</span><span class="p">,</span>
  <span class="n">include_run_keys</span> <span class="o">=</span> <span class="n">train_run_keys</span><span class="p">,</span>
  <span class="n">tmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
  <span class="n">tmax</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
  <span class="n">preload_files</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span>
<span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">)</span>


<span class="c1"># For validation, we&#39;ll use session 11 of Sherlock1</span>
<span class="n">val_data</span> <span class="o">=</span> <span class="n">LibriBrainSpeech</span><span class="p">(</span>
  <span class="n">data_path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_path</span><span class="si">}</span><span class="s2">/data/&quot;</span><span class="p">,</span>
  <span class="n">include_run_keys</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;0&quot;</span><span class="p">,</span><span class="s2">&quot;11&quot;</span><span class="p">,</span><span class="s2">&quot;Sherlock1&quot;</span><span class="p">,</span><span class="s2">&quot;2&quot;</span><span class="p">)],</span>
  <span class="n">standardize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
  <span class="n">tmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
  <span class="n">tmax</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
  <span class="n">preload_files</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span>
<span class="n">val_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">val_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">)</span>


<span class="c1"># For testing, we&#39;ll use session 12 of Sherlock1</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">LibriBrainSpeech</span><span class="p">(</span>
  <span class="n">data_path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_path</span><span class="si">}</span><span class="s2">/data/&quot;</span><span class="p">,</span>
  <span class="n">include_run_keys</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;0&quot;</span><span class="p">,</span><span class="s2">&quot;12&quot;</span><span class="p">,</span><span class="s2">&quot;Sherlock1&quot;</span><span class="p">,</span><span class="s2">&quot;2&quot;</span><span class="p">)],</span>
  <span class="n">standardize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
  <span class="n">tmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
  <span class="n">tmax</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
  <span class="n">preload_files</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span>
<span class="n">test_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of training samples:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of validation samples:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_data</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of test samples:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_data</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>In our experience, however, it can pay off to take some time to do additional preparation, so let‚Äôs do that next.</p>
<section id="simplifying-the-prediction-task">
<h4>Simplifying the prediction task<a class="headerlink" href="#simplifying-the-prediction-task" title="Link to this heading">#</a></h4>
<p>As it stands, the dataset expects the model to predict 200 labels per sample - one for every timestep in the input (remember that each sample is composed of 0.8s of data at 250Hz, each containing the sensor values of 306 sensors at that point in time).</p>
<p>Turns out, this is a pretty hard task to learn. So instead, what if the model only had to produce a single prediction per sample ‚Äî specifically, whether the middle time point in a 200-sample corresponds to speech or not? The input would still be the full 0.8 seconds of MEG data (i.e., 200 time steps), but the model‚Äôs output would now be a single label for the central time step. This doesn‚Äôt mean we lose the ability to predict labels for all time points. Instead, we can slide a 200-sample ‚Äúwindow‚Äù across the recording, one timestep at a time, making a prediction for the center of each sample window. In this way, the model still makes predictions for all timesteps, but each one is made with context from both the past and future.</p>
</section>
<section id="sensor-masking">
<h4>Sensor masking<a class="headerlink" href="#sensor-masking" title="Link to this heading">#</a></h4>
<p>We identified some sensors that provided more activity at relevant frequencies than others during speech periods.
In our experience, only including these sensors in training can lead to improved results. These empirical results track with prior research showing these areas as being important for speech processing.
Note that you can visualize ‚Äúour‚Äù mask in the sensor location visualization above.</p>
<p>Take a look at the comparison below - this does look much more managable, right? (Right-click -&gt; New Tab if the text is too small to read)</p>
<p><img alt="Task comparison" src="https://neural-processing-lab.github.io/2025-libribrain-competition/speech-colab-task-comparison.png" /></p>
<p>We‚Äôve implemented both of these adaptions into the <code class="docutils literal notranslate"><span class="pre">FilteredDataset</span></code> below, which is the dataset we‚Äôll use for training.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">platform</span>

<span class="c1"># These are the sensors we identified as being particularly useful</span>
<span class="n">SENSORS_SPEECH_MASK</span> <span class="o">=</span> <span class="p">[</span><span class="mi">18</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">138</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">142</span><span class="p">,</span> <span class="mi">143</span><span class="p">,</span> <span class="mi">145</span><span class="p">,</span>
                       <span class="mi">146</span><span class="p">,</span> <span class="mi">147</span><span class="p">,</span> <span class="mi">149</span><span class="p">,</span> <span class="mi">175</span><span class="p">,</span> <span class="mi">176</span><span class="p">,</span> <span class="mi">177</span><span class="p">,</span> <span class="mi">179</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">198</span><span class="p">,</span> <span class="mi">271</span><span class="p">,</span> <span class="mi">272</span><span class="p">,</span> <span class="mi">275</span><span class="p">]</span>

<span class="k">class</span><span class="w"> </span><span class="nc">FilteredDataset</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters:</span>
<span class="sd">        dataset: LibriBrain dataset.</span>
<span class="sd">        limit_samples (int, optional): If provided, limits the length of the dataset to this</span>
<span class="sd">                          number of samples.</span>
<span class="sd">        speech_silence_only (bool, optional): If True, only includes segments that are either</span>
<span class="sd">                          purely speech or purely silence (with additional balancing).</span>
<span class="sd">        apply_sensors_speech_mask (bool, optional): If True, applies a fixed sensor mask to the sensor</span>
<span class="sd">                          data in each sample.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">dataset</span><span class="p">,</span>
                 <span class="n">limit_samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">disable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">apply_sensors_speech_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_samples</span> <span class="o">=</span> <span class="n">limit_samples</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_sensors_speech_mask</span> <span class="o">=</span> <span class="n">apply_sensors_speech_mask</span>

        <span class="c1"># These are the sensors we identified:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sensors_speech_mask</span> <span class="o">=</span> <span class="n">SENSORS_SPEECH_MASK</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">balanced_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">samples</span><span class="p">)))</span>
        <span class="c1"># Shuffle the indices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">balanced_indices</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">balanced_indices</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">balanced_indices</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the number of samples in the filtered dataset.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_samples</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">balanced_indices</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="c1"># Map index to the original dataset using balanced indices</span>
        <span class="n">original_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">balanced_indices</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_sensors_speech_mask</span><span class="p">:</span>
            <span class="n">sensors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">original_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">sensors_speech_mask</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sensors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">original_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">][:]</span>
        <span class="n">label_from_the_middle_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">original_idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">sensors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">original_idx</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">label_from_the_middle_idx</span><span class="p">]]</span>


<span class="c1"># Conditionally set num_workers to avoid multiprocessing issues (try increasing if performance is problematic)</span>
<span class="n">num_workers</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">in_colab</span> <span class="k">else</span> <span class="mi">0</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Filtered dataset:&quot;</span><span class="p">)</span>
<span class="n">train_data_filtered</span> <span class="o">=</span> <span class="n">FilteredDataset</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>
<span class="n">train_loader_filtered</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_data_filtered</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Train data contains </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_data_filtered</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples&quot;</span><span class="p">)</span>

<span class="n">val_data_filtered</span> <span class="o">=</span> <span class="n">FilteredDataset</span><span class="p">(</span><span class="n">val_data</span><span class="p">)</span>
<span class="n">val_loader_filtered</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">val_data_filtered</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validation data contains </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">val_data_filtered</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples&quot;</span><span class="p">)</span>

<span class="n">test_data_filtered</span> <span class="o">=</span> <span class="n">FilteredDataset</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
<span class="n">test_loader_filtered</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">test_data_filtered</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test data contains </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test_data_filtered</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Let&#39;s look at the first batch:</span>
<span class="n">first_batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">train_loader_filtered</span><span class="p">))</span>
<span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">first_batch</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Batch input shape:&quot;</span><span class="p">,</span> <span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Batch label shape:&quot;</span><span class="p">,</span> <span class="n">labels</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">first_input</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">first_label</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Single sample input shape:&quot;</span><span class="p">,</span> <span class="n">first_input</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Single sample label is just a single value now!&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">First sample input:&quot;</span><span class="p">,</span> <span class="n">first_input</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;First sample label:&quot;</span><span class="p">,</span> <span class="n">first_label</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="actual-training-loop">
<h3>Actual training loop<a class="headerlink" href="#actual-training-loop" title="Link to this heading">#</a></h3>
<p>With all that out of the way, let‚Äôs actually train the model! First, we define the actual model architecture. We will use a 1 Dimensional Convolutional layer - to process the spatial relations between the sensors, followed by a 2 layer LSTM to process the temporal dynamics within each segment.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SpeechModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters:</span>
<span class="sd">        input_dim (int): Number of channels/features in the input tensor (usually SENSORS_SPEECH_MASK)</span>
<span class="sd">        model_dim (int): Dimensionality for the intermediate model representation.</span>
<span class="sd">        dropout_rate (float, optional): Dropout probability applied after convolutional and LSTM layers.</span>
<span class="sd">        lstm_layers (int, optional): Number of layers in the LSTM module.</span>
<span class="sd">        bi_directional (bool, optional): If True, uses a bidirectional LSTM; otherwise, a unidirectional LSTM.</span>
<span class="sd">        batch_norm (bool, optional): Indicates whether to use batch normalization.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_dim</span><span class="p">,</span> <span class="n">model_dim</span><span class="p">,</span> <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">lstm_layers</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bi_directional</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">batch_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv1d</span><span class="p">(</span>
            <span class="n">in_channels</span><span class="o">=</span><span class="n">input_dim</span><span class="p">,</span>
            <span class="n">out_channels</span><span class="o">=</span><span class="n">model_dim</span><span class="p">,</span>
            <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lstm_layers</span> <span class="o">=</span> <span class="n">lstm_layers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_norm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="n">num_features</span><span class="o">=</span><span class="n">model_dim</span><span class="p">)</span> <span class="k">if</span> <span class="n">batch_norm</span> <span class="k">else</span> <span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv_dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">dropout_rate</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span>
            <span class="n">input_size</span><span class="o">=</span><span class="n">model_dim</span><span class="p">,</span>
            <span class="n">hidden_size</span><span class="o">=</span><span class="n">model_dim</span><span class="p">,</span>
            <span class="n">num_layers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lstm_layers</span><span class="p">,</span>
            <span class="n">dropout</span><span class="o">=</span><span class="n">dropout_rate</span><span class="p">,</span>
            <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">bidirectional</span><span class="o">=</span><span class="n">bi_directional</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lstm_dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">dropout_rate</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speech_classifier</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">model_dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_norm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_dropout</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="c1"># LSTM expects (batch, seq_len, input_size)</span>
        <span class="n">output</span><span class="p">,</span> <span class="p">(</span><span class="n">h_n</span><span class="p">,</span> <span class="n">c_n</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">last_layer_h_n</span> <span class="o">=</span> <span class="n">h_n</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm_layers</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># handle more than one layer</span>
            <span class="n">last_layer_h_n</span> <span class="o">=</span> <span class="n">h_n</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">last_layer_h_n</span> <span class="o">=</span> <span class="n">last_layer_h_n</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm_dropout</span><span class="p">(</span><span class="n">last_layer_h_n</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">start_dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">end_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">speech_classifier</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
</div>
<p>Next, let‚Äôs wrap the model in a <a class="reference external" href="https://lightning.ai/docs/pytorch/LTS/common/lightning_module.html">LightningModule</a> to save ourselves from some boilerplate.
This is also where we define our loss function (BCE with label smoothing) and optimizer (AdamW).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">lightning</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">L</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torchmetrics</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span><span class="p">,</span> <span class="n">jaccard_score</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torchmetrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">Precision</span><span class="p">,</span> <span class="n">Recall</span><span class="p">,</span> <span class="n">F1Score</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lightning.pytorch.callbacks</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callback</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torchmetrics.functional</span><span class="w"> </span><span class="kn">import</span> <span class="n">recall</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SpeechClassifier</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters:</span>
<span class="sd">        input_dim (int): Number of input channels/features. This is passed to the underlying SpeechModel.</span>
<span class="sd">        model_dim (int): Dimensionality of the intermediate model representation.</span>
<span class="sd">        learning_rate (float, optional): Learning rate for the optimizer.</span>
<span class="sd">        weight_decay (float, optional): Weight decay for the optimizer.</span>
<span class="sd">        batch_size (int, optional): Batch size used during training and evaluation.</span>
<span class="sd">        dropout_rate (float, optional): Dropout probability applied after convolutional and LSTM layers.</span>
<span class="sd">        smoothing (float, optional): Label smoothing factor applied in the BCEWithLogits loss.</span>
<span class="sd">        pos_weight (float, optional): Weight for the positive class in the BCEWithLogits loss.</span>
<span class="sd">        batch_norm (bool, optional): Indicates whether to use batch normalization.</span>
<span class="sd">        lstm_layers (int, optional): Number of layers in the LSTM module within the SpeechModel.</span>
<span class="sd">        bi_directional (bool, optional): If True, uses a bidirectional LSTM in the SpeechModel; otherwise, uses a unidirectional LSTM.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_dim</span><span class="p">,</span> <span class="n">model_dim</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">smoothing</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">pos_weight</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="p">,</span> <span class="n">batch_norm</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">lstm_layers</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bi_directional</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_hyperparameters</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="n">learning_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight_decay</span> <span class="o">=</span> <span class="n">weight_decay</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">SpeechModel</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">model_dim</span><span class="p">,</span> <span class="n">dropout_rate</span><span class="o">=</span><span class="n">dropout_rate</span><span class="p">,</span> <span class="n">lstm_layers</span><span class="o">=</span><span class="n">lstm_layers</span><span class="p">,</span> <span class="n">bi_directional</span><span class="o">=</span><span class="n">bi_directional</span><span class="p">,</span> <span class="n">batch_norm</span><span class="o">=</span><span class="n">batch_norm</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span> <span class="o">=</span> <span class="n">BCEWithLogitsLossWithSmoothing</span><span class="p">(</span><span class="n">smoothing</span><span class="o">=</span><span class="n">smoothing</span><span class="p">,</span> <span class="n">pos_weight</span> <span class="o">=</span> <span class="n">pos_weight</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">val_step_outputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_step_outputs</span> <span class="o">=</span> <span class="p">{}</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_shared_eval_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">stage</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># (batch, seq_len)</span>

        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>
        <span class="n">probs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">logits</span><span class="p">)</span>
        <span class="n">y_probs</span> <span class="o">=</span> <span class="n">probs</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>

        <span class="n">y_true</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">meg</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stage</span><span class="si">}</span><span class="s1">_loss&#39;</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loss</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">training_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shared_eval_step</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="s2">&quot;train&quot;</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">validation_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shared_eval_step</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">test_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># (batch, seq_len)</span>

        <span class="c1"># ugly, taking care of only one label</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">start_dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">end_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># (batch, seq_len) -&gt; (batch * seq_len, 1)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>
        <span class="n">probs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">logits</span><span class="p">)</span>

        <span class="c1"># Append data to the defaultdict</span>
        <span class="c1"># Ensure keys exist before appending</span>
        <span class="k">if</span> <span class="s2">&quot;y_probs&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_step_outputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_step_outputs</span><span class="p">[</span><span class="s2">&quot;y_probs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s2">&quot;y_true&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_step_outputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_step_outputs</span><span class="p">[</span><span class="s2">&quot;y_true&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s2">&quot;meg&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_step_outputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_step_outputs</span><span class="p">[</span><span class="s2">&quot;meg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Append data</span>
        <span class="k">if</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_step_outputs</span><span class="p">[</span><span class="s2">&quot;y_probs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="n">probs</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>  <span class="c1"># (batch, seq_len)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_step_outputs</span><span class="p">[</span><span class="s2">&quot;y_probs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="n">probs</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>  <span class="c1"># (batch, seq_len)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">test_step_outputs</span><span class="p">[</span><span class="s2">&quot;y_true&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>  <span class="c1"># (batch, seq_len)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_step_outputs</span><span class="p">[</span><span class="s2">&quot;meg&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>  <span class="c1"># MEG data (batch, channels, seq_len)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shared_eval_step</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">configure_optimizers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weight_decay</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">optimizer</span>


<span class="k">class</span><span class="w"> </span><span class="nc">BCEWithLogitsLossWithSmoothing</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smoothing</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">pos_weight</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Binary Cross-Entropy Loss with Deterministic Label Smoothing.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            smoothing (float): Smoothing factor. Must be between 0 and 1.</span>
<span class="sd">            pos_weight (float): Weight for the positive class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smoothing</span> <span class="o">=</span> <span class="n">smoothing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bce_loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BCEWithLogitsLoss</span><span class="p">(</span><span class="n">pos_weight</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">pos_weight</span><span class="p">]))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logits</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>  <span class="c1"># Ensure target is a float tensor</span>
        <span class="n">target_smoothed</span> <span class="o">=</span> <span class="n">target</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">smoothing</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">smoothing</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bce_loss</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">target_smoothed</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, here‚Äôs the training loop. We‚Äôll either use a basic CSVLogger when running locally or the built-in Tensorboard in Colab for logging to keep things self-contained.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lightning</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">L</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lightning.pytorch.loggers</span><span class="w"> </span><span class="kn">import</span> <span class="n">TensorBoardLogger</span><span class="p">,</span> <span class="n">CSVLogger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lightning.pytorch.callbacks</span><span class="w"> </span><span class="kn">import</span> <span class="n">EarlyStopping</span>


<span class="c1"># Setup paths for logs and checkpoints</span>
<span class="n">LOG_DIR</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_path</span><span class="si">}</span><span class="s2">/lightning_logs&quot;</span>
<span class="n">CHECKPOINT_PATH</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_path</span><span class="si">}</span><span class="s2">/models/speech_model.ckpt&quot;</span>

<span class="c1"># Minimal logging setup</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">CSVLogger</span><span class="p">(</span>
    <span class="n">save_dir</span><span class="o">=</span><span class="n">LOG_DIR</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">if</span> <span class="n">in_colab</span><span class="p">:</span>  <span class="c1"># In Colab, we use the built-in Tensorboard setup</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">TensorBoardLogger</span><span class="p">(</span>
        <span class="n">save_dir</span><span class="o">=</span><span class="n">LOG_DIR</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">version</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">default_hp_metric</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">LOG_DIR</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">LOG_DIR</span><span class="p">)</span>
    <span class="o">%</span><span class="n">load_ext</span> <span class="n">tensorboard</span>
    <span class="o">%</span><span class="n">tensorboard</span> <span class="o">--</span><span class="n">logdir</span> <span class="err">$</span><span class="n">LOG_DIR</span>


<span class="c1"># Set a fixed seed for reproducibility</span>
<span class="n">L</span><span class="o">.</span><span class="n">seed_everything</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># Initialize the SpeechClassifier model</span>
<span class="c1"># Note: Feel free to play around with the hyperparameters here!</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">SpeechClassifier</span><span class="p">(</span>
    <span class="n">input_dim</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">SENSORS_SPEECH_MASK</span><span class="p">),</span>
    <span class="n">model_dim</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">learning_rate</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
    <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">lstm_layers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">weight_decay</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
    <span class="n">batch_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">bi_directional</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>

<span class="c1"># Log Hyperparameters</span>
<span class="n">logger</span><span class="o">.</span><span class="n">log_hyperparams</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">hparams</span><span class="p">)</span>

<span class="c1"># Optional: Early stopping</span>
<span class="c1">#           In our testing, we experienced a lot of issues with overfitting.</span>
<span class="c1">#           We resolve this by stopping training if validation loss stops going down</span>
<span class="n">early_stopping_callback</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span>
    <span class="n">monitor</span><span class="o">=</span><span class="s2">&quot;val_loss&quot;</span><span class="p">,</span>
    <span class="n">min_delta</span><span class="o">=</span><span class="mf">0.00</span><span class="p">,</span>
    <span class="n">patience</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;min&quot;</span>
<span class="p">)</span>

<span class="c1"># Initialize trainer</span>
<span class="n">trainer</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">Trainer</span><span class="p">(</span>
    <span class="n">devices</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="n">max_epochs</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
    <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
    <span class="n">enable_checkpointing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">early_stopping_callback</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Actually train the model</span>
<span class="n">trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_loader_filtered</span><span class="p">,</span> <span class="n">val_loader_filtered</span><span class="p">)</span>
<span class="c1"># Save trained model weights</span>
<span class="n">trainer</span><span class="o">.</span><span class="n">save_checkpoint</span><span class="p">(</span><span class="n">CHECKPOINT_PATH</span><span class="p">)</span>
<span class="c1"># Test trained model</span>
<span class="n">trainer</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_loader_filtered</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>If you instead wish to load pretrained model weights, you can do so here:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">lightning</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">L</span>


<span class="c1"># Setup checkpoint path</span>
<span class="n">CHECKPOINT_PATH</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_path</span><span class="si">}</span><span class="s2">/models/speech_model.ckpt&quot;</span>

<span class="c1"># # Optional: Download the model</span>
<span class="c1"># model_url = &quot;https://neural-processing-lab.github.io/2025-libribrain-competition/speech_model.ckpt&quot;</span>
<span class="c1"># response = requests.get(model_url)</span>
<span class="c1"># os.makedirs(os.path.dirname(CHECKPOINT_PATH), exist_ok=True)</span>
<span class="c1"># with open(CHECKPOINT_PATH, &quot;wb&quot;) as f:</span>
<span class="c1">#     f.write(response.content)</span>
<span class="c1"># print(&quot;Download of model checkpoint complete.&quot;)</span>

<span class="c1"># Set a fixed seed for reproducibility (just in case)</span>
<span class="n">L</span><span class="o">.</span><span class="n">seed_everything</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># Load the SpeechClassifier model from checkpoint</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">SpeechClassifier</span><span class="o">.</span><span class="n">load_from_checkpoint</span><span class="p">(</span>
    <span class="n">checkpoint_path</span><span class="o">=</span><span class="n">CHECKPOINT_PATH</span><span class="p">,</span>
    <span class="n">input_dim</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">SENSORS_SPEECH_MASK</span><span class="p">),</span>
    <span class="n">model_dim</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">learning_rate</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
    <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">lstm_layers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">weight_decay</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
    <span class="n">batch_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">bi_directional</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>

<span class="c1"># Initialize trainer and test loaded model</span>
<span class="n">trainer</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">Trainer</span><span class="p">(</span><span class="n">devices</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>
<span class="n">trainer</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_loader_filtered</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="evaluating-the-model">
<h2>Evaluating the model<a class="headerlink" href="#evaluating-the-model" title="Link to this heading">#</a></h2>
<p>You‚Äôve now trained your model - congratulations! Let‚Äôs check out the test accuracy on unseen data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">trainer</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dataloaders</span><span class="o">=</span><span class="n">test_loader_filtered</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Well, that sounds good but doesn‚Äôt really tell us anything, so let‚Äôs take a deeper look at the model‚Äôs performance. We‚Äôll start by running some predictions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="n">all_y_true</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">all_y_probs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="c1"># # Uncomment to compute statistics on training (might be slow!)</span>
    <span class="c1"># for batch in train_loader_filtered:</span>
    <span class="c1">#     x, y = batch</span>
    <span class="c1">#     logits = model(x)</span>
    <span class="c1">#     probs = torch.sigmoid(logits)</span>

    <span class="c1">#     all_y_true.append(y)</span>
    <span class="c1">#     all_y_probs.append(probs)</span>

    <span class="c1"># Uncomment to compute statistics on validation set</span>
    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">val_loader_filtered</span><span class="p">:</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">batch</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">probs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">logits</span><span class="p">)</span>

        <span class="n">all_y_true</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">all_y_probs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">probs</span><span class="p">)</span>

    <span class="c1"># Uncomment to compute statistics on test set</span>
    <span class="c1"># for batch in test_loader_filtered:</span>
    <span class="c1">#     x, y = batch</span>
    <span class="c1">#     logits = model(x)</span>
    <span class="c1">#     probs = torch.sigmoid(logits)</span>

    <span class="c1">#     all_y_true.append(y)</span>
    <span class="c1">#     all_y_probs.append(probs)</span>


<span class="n">y_true</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">all_y_true</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">y_probs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">all_y_probs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ready to compute statistics with &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_true</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot; samples.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let‚Äôs plot <a class="reference external" href="https://en.wikipedia.org/wiki/Receiver_operating_characteristic">ROC</a> curve. Ideally, we want this graph to immediately rise to (0/1) at the start of the graph.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>


<span class="k">def</span><span class="w"> </span><span class="nf">plot_auc_roc</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">probs</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;ROC Curve&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates an AUC-ROC plot.</span>

<span class="sd">    Args:</span>
<span class="sd">        labels (torch.Tensor or np.ndarray): Ground truth binary labels (shape: [num_segments, sequence_length]).</span>
<span class="sd">        probs (torch.Tensor or np.ndarray): Predicted probabilities for the positive class (shape: [num_segments, sequence_length]).</span>
<span class="sd">        title (str): Title of the plot.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert to NumPy if necessary</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">probs</span> <span class="o">=</span> <span class="n">probs</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

    <span class="c1"># Flatten the data to treat all predictions equally</span>
    <span class="n">labels_flat</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">probs_flat</span> <span class="o">=</span> <span class="n">probs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="c1"># Compute ROC curve and AUC</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">labels_flat</span><span class="p">,</span> <span class="n">probs_flat</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>

    <span class="c1"># Plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Random Guess&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;False Positive Rate (FPR)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;True Positive Rate (TPR)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">roc_auc</span>


<span class="n">fig</span><span class="p">,</span> <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">plot_auc_roc</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_probs</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">AUC is &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">roc_auc</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Note that even poor models may look okay due to the imbalance of the dataset. Let‚Äôs take a look at our models predictions in a <a class="reference external" href="https://en.wikipedia.org/wiki/Confusion_matrix">confusion matrix</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">confusion_matrix</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="kn">import</span> <span class="n">ListedColormap</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">jaccard_score</span>


<span class="k">def</span><span class="w"> </span><span class="nf">plot_confusion_matrix_1s_0s</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">preds</span><span class="p">):</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">preds</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="c1"># Compute confusion matrix</span>
    <span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Create a binary matrix indicating correct predictions (diagonals) as 1 and incorrect as 0</span>
    <span class="n">cell_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">cm</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">cell_type</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># Define a custom colormap: 0 -&gt; red (incorrect), 1 -&gt; blue (correct)</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">ListedColormap</span><span class="p">([</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">])</span>

    <span class="c1"># Plot using matplotlib&#39;s imshow</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cell_type</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>

    <span class="c1"># Overlay the confusion matrix numbers on top of the colored cells</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span>
                    <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

    <span class="c1"># Set tick labels</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s2">&quot;Predicted 0&quot;</span><span class="p">,</span> <span class="s2">&quot;Predicted 1&quot;</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s2">&quot;True 0&quot;</span><span class="p">,</span> <span class="s2">&quot;True 1&quot;</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Predicted Label&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;True Label&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Confusion Matrix&quot;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">fig</span>


<span class="c1"># Assuming your test_step_outputs dict has been populated from trainer.test(model, test_loader)</span>
<span class="c1"># Convert the collected outputs into numpy arrays and flatten them if needed</span>
<span class="n">y_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span>
<span class="n">y_probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_probs</span><span class="p">)</span>

<span class="c1"># Convert probabilities to binary predictions using a threshold of 0.5</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_probs</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># Use the provided function to plot the confusion matrix</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plot_confusion_matrix_1s_0s</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

<span class="c1"># Display the plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="n">iou</span> <span class="o">=</span> <span class="n">jaccard_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s2">&quot;binary&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">IoU (Jaccard Index) is &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iou</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="that-s-it">
<h2>That‚Äôs it! ü•≥<a class="headerlink" href="#that-s-it" title="Link to this heading">#</a></h2>
<p>Thanks for taking the time to look at and/or participate in our competition. If this caught your interest, you might also want to take a look at the more advanced version of the task, focussed on Phoneme Classification - you can find the corresponding Colab <a class="reference external" href="https://neural-processing-lab.github.io/2025-libribrain-competition/links/phoneme-colab">here</a>. If you have any open questions, please get in touch through <a class="reference external" href="https://neural-processing-lab.github.io/2025-libribrain-competition/links/discord">our Discord server</a>. Ready to submit your model? You might want to take a look at the <a class="reference external" href="https://neural-processing-lab.github.io/2025-libribrain-competition/links/submission-colab">submission tutorial</a> or the <a class="reference external" href="https://neural-processing-lab.github.io/2025-libribrain-competition">LibriBrain competition website</a>.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="libribrain.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">LibriBrain</p>
      </div>
    </a>
    <a class="right-next"
       href="LibriBrain_Competition_Phoneme_Classification.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Phoneme Classification (LibriBrain)</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-up-dependencies">Setting up dependencies</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#understanding-the-dataset">Understanding the dataset</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-the-data">Exploring the data</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#hdf5-files">HDF5 files</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#labels">Labels</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#understanding-the-task">Understanding the task</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#in-this-notebook">In this notebook‚Ä¶</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#training-a-model">Training a model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#preparing-the-data">Preparing the data</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#simplifying-the-prediction-task">Simplifying the prediction task</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#sensor-masking">Sensor masking</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#actual-training-loop">Actual training loop</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluating-the-model">Evaluating the model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#that-s-it">That‚Äôs it! ü•≥</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Neural Processing Lab
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      ¬© Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>